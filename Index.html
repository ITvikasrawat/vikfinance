<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker</title>
    
    <!-- ‚úÖ Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Outfit:wght@400;600&display=swap" rel="stylesheet">
	
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['Roboto', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- Header & Cards --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .hero-card {
            background: linear-gradient(135deg, #4f46e5 0%, #312e81 100%);
            box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.5);
        }

        /* --- üõ†Ô∏è FIXED TRANSACTION LIST STYLES --- */
        
        /* Date Header (Sticky Top) */
        .day-header {
		background: rgba(248, 250, 252, 0.95);
		backdrop-filter: blur(5px);
		padding: 10px 16px;
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: sticky; /* Sticky zaroori hai */
		top: 12px;           /* Top se chipkega */
		z-index: 9;
		border-bottom: 1px solid #e2e8f0;
		box-shadow: 0 1px 2px rgba(0,0,0,0.02);
		/* ‚úÖ Added: Corners round kiye taaki sharp na lage */
		border-radius: 0.75rem 0.75rem 0 0; 
		}
        
        .date-block { display: flex; align-items: baseline; gap: 6px; }
        .date-day { font-size: 1.4rem; font-weight: 800; font-family: 'Roboto', sans-serif; color: #1e293b; line-height: 1; }
        .day-badge { font-size: 0.65rem; font-weight: 700; color: white; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; transform: translateY(-3px); }
        .date-full { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }

        /* Entry Row (Flex Layout Fixed) */
        .entry-row {
            background: #fff;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 14px; /* Gap between icon and text */
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.1s;
        }
        .entry-row:active { background: #f8fafc; }

        /* Icon Column */
        .col-icon {
            width: 44px; height: 44px;
            border-radius: 50%; /* Circular Icon */
            background: #f8fafc;
            border: 1px solid #f1f5f9;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Text Column (Takes remaining space) */
        .col-text {
            flex: 1;
            min-width: 0; /* Enable truncation */
            display: flex; flex-direction: column; justify-content: center;
        }

        /* Amount Column (Right Aligned) */
        .col-amt {
            text-align: right;
            flex-shrink: 0;
        }

        /* --- Components --- */
        .fab {
            position: fixed; bottom: 90px; right: 20px;
            background: #4f46e5; color: white;
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            border: none; cursor: pointer; z-index: 40; transition: transform 0.1s;
        }
        .fab:active { transform: scale(0.95); }

        /* --- FIXED & SMOOTH MODAL CSS --- */
		.modal-overlay {
			background: rgba(15, 23, 42, 0.6);
			backdrop-filter: blur(4px);
			position: fixed; inset: 0; z-index: 50;
			opacity: 0; visibility: hidden;
			transition: opacity 0.3s ease, visibility 0.3s ease;
			display: flex; align-items: flex-end; justify-content: center;
		}

		.modal-overlay.active {
			opacity: 1; visibility: visible;
		}

		.modal-card {
			background: white; width: 100%; border-radius: 2.5rem 2.5rem 0 0;
			max-height: 95vh; display: flex; flex-direction: column;
			/* Default Hidden Position (Neeche) */
			transform: translateY(100%);
			/* Smooth Physics Animation */
			transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
		}

		.modal-overlay.active .modal-card {
			/* Visible Position (Upar) */
			transform: translateY(0);
		}
		
		/* --- GLASS CREDIT CARD --- */
		.glass-card {
			background: linear-gradient(135deg, #312e81 0%, #4338ca 100%); /* Deep Royal Blue */
			position: relative;
			overflow: hidden;
			border: 1px solid rgba(255, 255, 255, 0.1);
			box-shadow: 0 25px 50px -12px rgba(49, 46, 129, 0.6); /* Deep Shadow */
		}

		/* Texture overlay */
		.glass-card::before {
			content: ''; position: absolute;
			top: 0; left: 0; right: 0; bottom: 0;
			background: radial-gradient(circle at top right, rgba(255,255,255,0.1), transparent 60%);
			pointer-events: none;
		}
		
    </style>
</head>
<body class="font-sans text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER (Mr. Vikas - Dual Color Standard Font) -->
    <header class="fixed top-0 w-full glass-header z-40">
        <div class="flex justify-between items-end px-6 py-4 max-w-lg mx-auto">
            
            <!-- LEFT: Greeting & Name -->
            <div class="flex flex-col">
                <!-- Dynamic Greeting -->
                <p id="greeting-text" class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">
                    Welcome Back
                </p>
                
                <!-- Dual Color Name Row -->
                <div class="flex items-center gap-3">
                    
                    <!-- Mr. Vikas (Dual Color) -->
                    <div class="flex items-baseline gap-1">
                        <span class="text-xl font-bold text-slate-500 tracking-tight">Mr.</span>
                        <span class="text-2xl font-black text-indigo-600 tracking-tight">Vikas</span>
                    </div>
                    
                    <!-- Wifi Signal Icon -->
                    <div id="sync-indicator" class="w-6 h-6 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center transition-all duration-300">
                        <i id="sync-icon" class="fas fa-wifi text-[10px] text-emerald-500"></i>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Month Filter -->
            <div class="relative group">
                <select id="monthFilter" class="appearance-none bg-white/80 backdrop-blur-md border border-slate-200 text-slate-700 font-bold text-xs py-2.5 pl-4 pr-9 rounded-2xl outline-none shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all cursor-pointer" onchange="handleMonthChange()"></select>
                <i class="fas fa-chevron-down absolute right-3.5 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 group-hover:text-indigo-500 transition-colors pointer-events-none"></i>
            </div>

        </div>
    </header>
	
	
    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto pt-16 pb-20 w-full no-scrollbar bg-slate-50" id="main-scroll">
        
        <!-- HOME TAB -->
        <div id="tab-home" class="tab-content active">
            
   <!-- HERO: Matte Dark Card with Correct Icons -->
<div class="relative px-5 mt-6 mb-8 perspective-1000 group">
    
    <!-- 1. Background Glow -->
    <div class="absolute -inset-0.5 bg-gradient-to-r from-gray-700 to-slate-900 rounded-2xl blur opacity-30 group-hover:opacity-50 transition duration-500"></div>

    <!-- 2. The Card -->
    <div class="relative w-full aspect-[1.58/1] rounded-2xl overflow-hidden shadow-2xl transition-transform duration-500 hover:scale-[1.01] border border-white/10"
         style="background: linear-gradient(135deg, #1e293b 0%, #020617 100%);">
        
        <!-- Texture Overlay -->
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 mix-blend-overlay"></div>

        <div class="relative z-10 flex flex-col justify-between h-full p-6 text-white font-mono">
            
            <!-- TOP ROW: Chip, Wifi & Logo -->
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-2">
                    
                    <!-- 1. EMV CHIP (From your code) -->
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="45px" height="45px" viewBox="0 0 50 50" xml:space="preserve" class="drop-shadow-md">
                        <image id="image0" width="50" height="50" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
                        AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAB6VBMVEUAAACNcTiVeUKVeUOY
                        fEaafEeUeUSYfEWZfEaykleyklaXe0SWekSZZjOYfEWYe0WXfUWXe0WcgEicfkiXe0SVekSXekSW
                        ekKYe0a9nF67m12ZfUWUeEaXfESVekOdgEmVeUWWekSniU+VeUKVeUOrjFKYfEWliE6WeESZe0GS
                        e0WYfES7ml2Xe0WXeESUeEOWfEWcf0eWfESXe0SXfEWYekSVeUKXfEWxklawkVaZfEWWekOUekOW
                        ekSYfESZe0eXekWYfEWZe0WZe0eVeUSWeETAnmDCoWLJpmbxy4P1zoXwyoLIpWbjvXjivnjgu3bf
                        u3beunWvkFWxkle/nmDivXiWekTnwXvkwHrCoWOuj1SXe0TEo2TDo2PlwHratnKZfEbQrWvPrWua
                        fUfbt3PJp2agg0v0zYX0zYSfgkvKp2frxX7mwHrlv3rsxn/yzIPgvHfduXWXe0XuyIDzzISsjVO1
                        lVm0lFitjVPzzIPqxX7duna0lVncuHTLqGjvyIHeuXXxyYGZfUayk1iyk1e2lln1zYTEomO2llrb
                        tnOafkjFpGSbfkfZtXLhvHfkv3nqxH3mwXujhU3KqWizlFilh06khk2fgkqsjlPHpWXJp2erjVOh
                        g0yWe0SliE+XekShhEvAn2D///+gx8TWAAAARnRSTlMACVCTtsRl7Pv7+vxkBab7pZv5+ZlL/UnU
                        /f3SJCVe+Fx39naA9/75XSMh0/3SSkia+pil/KRj7Pr662JPkrbP7OLQ0JFOijI1MwAAAAFiS0dE
                        orDd34wAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfnAg0IDx2lsiuJAAACLElEQVRIx2Ng
                        GAXkAUYmZhZWPICFmYkRVQcbOwenmzse4MbFzc6DpIGXj8PD04sA8PbhF+CFaxEU8iWkAQT8hEVg
                        OkTF/InR4eUVICYO1SIhCRMLDAoKDvFDVhUaEhwUFAjjSUlDdMiEhcOEItzdI6OiYxA6YqODIt3d
                        I2DcuDBZsBY5eVTr4xMSYcyk5BRUOXkFsBZFJTQnp6alQxgZmVloUkrKYC0qqmji2WE5EEZuWB6a
                        lKoKdi35YQUQRkFYPpFaCouKIYzi6EDitJSUlsGY5RWVRGjJLyxNy4ZxqtIqqvOxaVELQwZFZdkI
                        JVU1RSiSalAt6rUwUBdWG1CP6pT6gNqwOrgCdQyHNYR5YQFhDXj8MiK1IAeyN6aORiyBjByVTc0F
                        qBoKWpqwRCVSgilOaY2OaUPw29qjOzqLvTAchpos47u6EZyYnngUSRwpuTe6D+6qaFQdOPNLRzOM
                        1dzhRZyW+CZouHk3dWLXglFcFIflQhj9YWjJGlZcaKAVSvjyPrRQ0oQVKDAQHlYFYUwIm4gqExGm
                        BSkutaVQJeomwViTJqPK6OhCy2Q9sQBk8cY0DxjTJw0lAQWK6cOKfgNhpKK7ZMpUeF3jPa28BCET
                        amiEqJKM+X1gxvWXpoUjVIVPnwErw71nmpgiqiQGBjNzbgs3j1nus+fMndc+Cwm0T52/oNR9lsdC
                        S24ra7Tq1cbWjpXV3sHRCb1idXZ0sGdltXNxRateRwHRAACYHutzk/2I5QAAACV0RVh0ZGF0ZTpj
                        cmVhdGUAMjAyMy0wMi0xM1QwODoxNToyOSswMDowMEUnN7UAAAAldEVYdGRhdGU6bW9kaWZ5ADIw
                        MjMtMDItMTNUMDg6MTU6MjkrMDA6MDA0eo8JAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTAy
                        LTEzVDA4OjE1OjI5KzAwOjAwY2+u1gAAAABJRU5ErkJggg=="></image>
                    </svg>

                    <!-- Wifi / Contactless Icon (Silver-White) -->
<svg class="w-8 h-8 text-white/50 rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 0 1 7.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 0 1 1.06 0Z" />
</svg>
                </div>
                
                <!-- 3. LOGO (Mastercard) -->
                <svg class="drop-shadow-md" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="36" height="36" viewBox="0 0 48 48">
                    <path fill="#ff9800" d="M32 10A14 14 0 1 0 32 38A14 14 0 1 0 32 10Z"></path>
                    <path fill="#d50000" d="M16 10A14 14 0 1 0 16 38A14 14 0 1 0 16 10Z"></path>
                    <path fill="#ff3d00" d="M18,24c0,4.755,2.376,8.95,6,11.48c3.624-2.53,6-6.725,6-11.48s-2.376-8.95-6-11.48 C20.376,15.05,18,19.245,18,24z"></path>
                </svg>
            </div>

            <!-- MIDDLE: Net Balance -->
            <div class="mt-2">
                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-[0.2em] mb-1 pl-1">Net Balance</p>
                <h2 class="text-4xl font-bold tracking-widest text-white drop-shadow-md font-sans" id="net-balance">
                    ****
                </h2>
            </div>

            <!-- BOTTOM: Name & Stats -->
            <div class="flex justify-between items-end mt-auto pt-2">
                
                <!-- LEFT: Name -->
                <div class="flex flex-col">
                    <p class="text-[7px] text-gray-500 font-bold uppercase tracking-wider mb-0.5">Card Holder</p>
                    <p class="text-sm font-bold tracking-widest text-gray-200 uppercase drop-shadow-sm font-sans truncate">
                        VIKAS RAWAT
                    </p>
                </div>

                <!-- RIGHT: Stats (Readable Size) -->
                <div class="flex items-center gap-4 text-right">
                    <div class="flex flex-col items-end">
                        <p class="text-[7px] font-bold text-gray-500 uppercase">INC</p>
                        <p class="text-[11px] font-bold text-emerald-400 tracking-wide" id="total-income">‚Çπ0</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <p class="text-[7px] font-bold text-gray-500 uppercase">EXP</p>
                        <p class="text-[11px] font-bold text-rose-400 tracking-wide" id="total-expense">‚Çπ0</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <p class="text-[7px] font-bold text-gray-500 uppercase">INV</p>
                        <p class="text-[11px] font-bold text-amber-400 tracking-wide" id="total-invest">‚Çπ0</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

            <!-- Transaction List -->
            <div id="transaction-container"></div>
            
            <!-- Empty State -->
            <div id="no-data" class="hidden text-center py-10 opacity-50">
                <i class="fas fa-receipt text-3xl text-slate-300 mb-2"></i>
                <p class="text-xs font-bold text-slate-400">No data found</p>
            </div>
        </div>

        <!-- STATS TAB -->
        <div id="tab-stats" class="tab-content px-4 py-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold text-xl text-slate-900">Analytics</h2>
                <button onclick="toggleChartLegend()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full">Legend</button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <select id="statsType" onchange="renderStats()" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 flex-1 font-bold outline-none"><option value="Expense">Expense</option><option value="Income">Income</option><option value="Investment">Invest</option></select>
                <select id="statsGroup" onchange="renderStats()" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg p-2.5 flex-1 font-bold outline-none"><option value="category">Category</option><option value="sub_category">Sub Cat</option></select>
            </div>

            <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm mb-6 relative">
                <div class="h-64 relative"><canvas id="expenseChart"></canvas></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none mt-6">
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Total</p>
                        <p class="text-lg font-black text-slate-800" id="chartTotal">‚Çπ0</p>
                    </div>
                </div>
            </div>
            <div id="stats-list" class="space-y-3 pb-20"></div>
        </div>
    </main>

    <!-- FAB -->
    <button class="fab" onclick="openModal('add')"><i class="fas fa-plus"></i></button>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-100 pb-safe z-50 h-16 flex items-center">
        <button class="flex-1 flex flex-col items-center justify-center text-indigo-600 transition" onclick="switchTab('home', this)">
            <i class="fas fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">Wallet</span>
        </button>
        <button class="flex-1 flex flex-col items-center justify-center text-slate-400 transition hover:text-indigo-600" onclick="switchTab('stats', this)">
            <i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">Stats</span>
        </button>
    </nav>

    <!-- Modal (Vibrant & Compact) -->
    <div id="entryModal" class="modal-overlay fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="absolute inset-0 bg-transparent" onclick="closeModal()"></div>
        <div id="modalCard" class="bg-white relative w-full sm:max-w-md rounded-t-[2.5rem] sm:rounded-3xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden transition-colors duration-300 modal-card">
            
            <!-- Header -->
            <div id="modalHeader" class="py-8 px-6 transition-colors duration-300 flex flex-col items-center justify-center shrink-0 relative overflow-hidden bg-rose-500">
                <button onclick="closeModal()" class="absolute top-5 right-5 w-8 h-8 rounded-full bg-white/20 text-white hover:bg-white/30 backdrop-blur-md flex items-center justify-center transition z-20">
                    <i class="fas fa-times text-sm"></i>
                </button>

                <div class="relative flex items-baseline justify-center mb-5 z-10">
                    <span class="text-3xl font-bold text-white/70 mr-1">‚Çπ</span>
                    <input type="number" id="amount" class="w-48 text-center text-6xl font-black text-white bg-transparent outline-none p-0 m-0 placeholder-white/30 drop-shadow-sm" placeholder="0" required>
                </div>

                <div class="relative z-10">
                    <div class="relative group">
                        <select id="type" onchange="applyTheme(this.value)" class="appearance-none w-40 bg-white text-rose-600 font-bold text-sm py-3 px-6 rounded-full text-center outline-none shadow-lg shadow-black/10 border-2 border-transparent focus:border-white/50 transition-all cursor-pointer">
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                            <option value="Investment">Investment</option>
                        </select>
                        <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <!-- Body -->
            <div class="bg-white flex-1 rounded-t-[2rem] px-6 pt-8 pb-4 overflow-y-auto no-scrollbar relative z-10 -mt-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
                <form id="entryForm" class="space-y-4">
                    <input type="hidden" id="entryId">
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Date</label>
                            <input type="date" id="date" class="w-full bg-slate-50 text-slate-700 text-sm font-bold rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors">
                        </div>
                        <div class="relative">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Account</label>
                            <select id="account" class="w-full bg-slate-50 text-slate-700 text-sm font-bold rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors truncate pr-8">
                                <option>Axis Bank</option><option>Cash</option><option>Flipkart Card</option><option>Amazon Card</option><option>Sunita</option><option>Other</option>
                            </select>
                            <i class="fas fa-wallet absolute right-3 top-[2.2rem] text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Category</label>
                            <select id="category" onchange="updateSubCategories()" class="w-full bg-slate-50 text-slate-700 text-sm font-bold rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors truncate pr-8">
                                <option value="">Select</option><option>üè† NEEDS</option><option>üéâ WANTS</option><option>üìà INVESTMENT</option><option>üí∞ Salary & Inc</option><option>üéÅ Windfall</option><option>üìà Passive</option>
                            </select>
                            <i class="fas fa-layer-group absolute right-3 top-[2.2rem] text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                        <div class="relative">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Sub-Category</label>
                            <select id="sub_category" class="w-full bg-slate-50 text-slate-700 text-sm font-bold rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors truncate pr-8">
                                <option value="">Select</option>
                            </select>
                            <i class="fas fa-caret-down absolute right-3 top-[2.2rem] text-slate-400 text-sm pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Title</label>
                        <input type="text" id="note" class="w-full bg-slate-50 text-slate-800 text-sm font-bold rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors" placeholder="E.g. Burger King" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Description <span class="opacity-50 font-normal">(Opt)</span></label>
                        <input type="text" id="description" class="w-full bg-slate-50 text-slate-600 text-sm font-medium rounded-xl h-11 px-3 outline-none border border-slate-100 focus:border-indigo-500 focus:bg-white transition-colors" placeholder="Details...">
                    </div>
                    <div class="h-2"></div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-4 bg-white border-t border-slate-50 shrink-0 pb-safe z-20">
                <div class="flex gap-3">
                    <button type="button" id="deleteBtn" onclick="deleteEntry()" class="hidden w-14 h-12 rounded-xl bg-slate-100 text-slate-500 hover:bg-rose-100 hover:text-rose-500 transition flex items-center justify-center"><i class="fas fa-trash-can text-lg"></i></button>
                    <button onclick="document.getElementById('entryForm').requestSubmit()" id="saveBtn" class="flex-1 h-12 rounded-xl bg-rose-600 text-white font-bold text-sm tracking-wide shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">UPDATE ENTRY</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ********************************************
    // ‚öôÔ∏è CONFIGURATION & STATE
    // ********************************************
    const API_URL = 'https://script.google.com/macros/s/AKfycbyP5LfSDcBteaExMJBsjJwX_pTOvO5JINMzOH2PnvYHFyzvA3uD_RrtWMiY-SGMIyeK/exec'; 
    const CACHE_KEY = 'finance_v3_cache';

    // Global Variables
    let allData = [];
    let currentFilter = { year: new Date().getFullYear(), month: new Date().getMonth() };
    let expenseChart = null;
    let showChartLegend = true;

    // üìÇ Categories Mapping
    const categoryMap = {
        "üè† NEEDS": ["üõí Food & Groceries", "üè† Housing & Utilities", "üõµ Transportation", "üå™Ô∏è Healthcare & Buffers", "üõ°Ô∏è Insurance", "üéì Child's Education", "üîß Home Maintenance"],
        "üéâ WANTS": ["‚ò†Ô∏è Junk Food & Treats", "üçΩÔ∏è Restaurant & Online Food Orders", "üõçÔ∏è Shopping", "üíÖ Personal Care & Fitness", "üéÅ Gifts & Celebrations", "üé¨ Entertainment"],
        "üìà INVESTMENT": ["üìà Equity Mutual Funds (SIP)", "üè° Kedar Co-operative Society", "üè¶ F Block Committee"],
        "üí∞ Salary & Income": ["üíµ PBL Monthly Payout"],
        "üìà Passive": ["üìà Fixed Deposit Interest", "üè¶ Savings Account Interest", "üí∏ Dividends", "üíπ Portfolio Income"],
        "üéÅ Windfall": ["üéÅ Gifts", "üåü Performance Bonus", "üí≥ Rewards & Cashback"]
    };

    // ********************************************
    // üì± MOBILE BACK BUTTON LOGIC
    // ********************************************
    // Jab user phone ka back button dabayega, modal band hoga (App band nahi hogi)
    window.addEventListener('popstate', function(event) {
        const modal = document.getElementById('entryModal');
        if (modal.classList.contains('active')) {
            modal.classList.remove('active');
        }
    });

    // ********************************************
    // üöÄ INITIALIZATION
    // ********************************************
    document.addEventListener('DOMContentLoaded', () => {
        // Set today's date
        document.getElementById('date').valueAsDate = new Date();
        
        // Data Load
        loadFromCache();
        fetchData();
    });

    // ********************************************
    // üì° DATA HANDLING
    // ********************************************
    function loadFromCache() {
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached) {
            try {
                allData = JSON.parse(cached);
                initDynamicDropdown();
                applyFilter();
            } catch(e) { console.error("Cache Error", e); }
        } else {
            initDynamicDropdown();
        }
    }

    async function fetchData() {
            const indicatorBox = document.getElementById('sync-indicator');
            const indicatorIcon = document.getElementById('sync-icon');
            
            // üîÑ START SYNC: Show Orange Spinner
            indicatorBox.className = "w-6 h-6 rounded-full bg-amber-50 border border-amber-100 flex items-center justify-center transition-all duration-300";
            indicatorIcon.className = "fas fa-sync-alt text-[10px] text-amber-500 animate-spin"; // Icon change to Sync + Spin

            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                if(json.status === 'success') {
                    allData = json.data.filter(i => i.Amount);
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allData));
                    initDynamicDropdown();
                    applyFilter();
                }
            } catch(e) { 
                console.error("Sync Error:", e); 
                // üî¥ ERROR STATE (Optional): Red Wifi with slash
                indicatorBox.className = "w-6 h-6 rounded-full bg-rose-50 border border-rose-100 flex items-center justify-center";
                indicatorIcon.className = "fas fa-wifi-slash text-[10px] text-rose-500";
            } finally { 
                // ‚úÖ ONLINE STATE: Back to Green Wifi
                // Thoda delay taaki user ko 'tick' feel aaye
                setTimeout(() => {
                    indicatorBox.className = "w-6 h-6 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center transition-all duration-300";
                    indicatorIcon.className = "fas fa-wifi text-[10px] text-emerald-500"; 
                }, 500);
            }
        }

    // ********************************************
    // üé® UI LOGIC: MODAL & THEMES
    // ********************************************
    
    // 1. Open Modal (Fix: Slide Animation + Data Fill)
    
	function openModal(mode, data) {
		const modal = document.getElementById('entryModal');
		modal.classList.add('active'); 

		if (mode === 'edit') {
			// --- EDIT MODE (Purana Logic Same rahega) ---
			document.getElementById('saveBtn').innerText = 'UPDATE';
			document.getElementById('deleteBtn').classList.remove('hidden');

			document.getElementById('entryId').value = data.ID;
			document.getElementById('amount').value = data.Amount;
			document.getElementById('type').value = data.Type;
			document.getElementById('account').value = data.Account;
			
			// Category & Sub-Cat Sync
			document.getElementById('category').value = data.Category;
			updateSubCategories(); 
			document.getElementById('sub_category').value = data['Sub-Category'];
			
			document.getElementById('note').value = data.Note || '';
			document.getElementById('description').value = data.Description || '';
			
			const d = parseDate(data.Date);
			const y = d.getFullYear();
			const m = String(d.getMonth()+1).padStart(2,'0');
			const day = String(d.getDate()).padStart(2,'0');
			document.getElementById('date').value = `${y}-${m}-${day}`;

			applyTheme(data.Type);

		} else {
			// --- ADD MODE (AB HOGA ASLI RESET) --- üßπ
			document.getElementById('saveBtn').innerText = 'SAVE';
			document.getElementById('deleteBtn').classList.add('hidden');
			
			// 1. Clear ID (Zaroori hai taaki Naya create ho)
			document.getElementById('entryId').value = '';

			// 2. Inputs ko Force Clear karo
			document.getElementById('amount').value = '';
			document.getElementById('note').value = '';   
			document.getElementById('description').value = ''; 

			// 3. Dropdowns Reset
			document.getElementById('type').value = 'Expense';
			document.getElementById('account').selectedIndex = 0; // First option select karo
			document.getElementById('category').selectedIndex = 0; 
			
			// 4. Sub-category saaf karo
			document.getElementById('sub_category').innerHTML = '<option value="">Select</option>';

			// 5. Date Aaj ki set karo
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('date').value = today;
			
			// 6. Theme Reset
			applyTheme('Expense');
		}
	}

    // 2. Close Modal (Fix: Slide Down)
    function closeModal() {
        const modal = document.getElementById('entryModal');
        
        // Agar browser history mein hash hai, to back karo
        if (window.location.hash === "#modal") {
            history.back(); 
        } else {
            // Fallback: Direct class remove
            modal.classList.remove('active');
        }
    }

    // 3. Apply Theme Colors
    function applyTheme(type) {
        const header = document.getElementById('modalHeader');
        const saveBtn = document.getElementById('saveBtn');
        const typeSelect = document.getElementById('type');
        
        // Base classes
        const headerBase = "py-8 px-6 transition-colors duration-300 flex flex-col items-center justify-center shrink-0 relative overflow-hidden ";
        const btnBase = "flex-1 h-12 rounded-xl text-white font-bold text-sm tracking-wide shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 ";
        const selectBase = "appearance-none w-40 bg-white font-bold text-sm py-3 px-6 rounded-full text-center outline-none shadow-lg shadow-black/10 border-2 border-transparent focus:border-white/50 transition-all cursor-pointer ";

        if (type === 'Income') {
            header.className = headerBase + 'bg-emerald-500';
            saveBtn.className = btnBase + 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200';
            typeSelect.className = selectBase + "text-emerald-600";
        } else if (type === 'Investment') {
            header.className = headerBase + 'bg-blue-600';
            saveBtn.className = btnBase + 'bg-blue-600 hover:bg-blue-700 shadow-blue-200';
            typeSelect.className = selectBase + "text-blue-600";
        } else {
            header.className = headerBase + 'bg-rose-500';
            saveBtn.className = btnBase + 'bg-rose-600 hover:bg-rose-700 shadow-rose-200';
            typeSelect.className = selectBase + "text-rose-600";
        }
    }

    function updateSubCategories() {
        const cat = document.getElementById('category').value;
        const sub = document.getElementById('sub_category');
        sub.innerHTML = '<option value="">Select</option>';
        const list = categoryMap[cat] || ["Other"];
        list.forEach(i => {
            const opt = document.createElement('option');
            opt.value = i; opt.innerText = i;
            sub.appendChild(opt);
        });
    }

    // ********************************************
    // üíæ FORM SUBMIT & DELETE
    // ********************************************
    document.getElementById('entryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = 'SAVING...'; btn.disabled = true;

        // Date Formatting for Sheets
        const rDate = document.getElementById('date').value;
        const dObj = new Date(rDate);
        const hh = new Date().getHours().toString().padStart(2,'0');
        const mm = new Date().getMinutes().toString().padStart(2,'0');
        const fDate = `${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getMonth()+1).padStart(2,'0')}/${dObj.getFullYear()} ${hh}:${mm}:00`;

        const payload = {
            action: document.getElementById('entryId').value ? 'edit' : 'add',
            ID: document.getElementById('entryId').value,
            Date: fDate,
            Type: document.getElementById('type').value,
            Category: document.getElementById('category').value,
            "Sub-Category": document.getElementById('sub_category').value,
            Account: document.getElementById('account').value,
            Amount: document.getElementById('amount').value,
            Description: document.getElementById('description').value,
            Note: document.getElementById('note').value
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            closeModal();
            fetchData();
        } catch(e) { 
            alert("Error saving data!"); 
        } finally { 
            btn.innerText = originalText; btn.disabled = false; 
        }
    });

    async function deleteEntry() {
        if(!confirm("Delete this?")) return;
        try {
            const id = document.getElementById('entryId').value;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'delete', ID: id}) });
            closeModal();
            fetchData();
        } catch(e) { alert("Delete failed"); }
    }

    // ********************************************
    // üìä HELPERS & RENDER LOGIC
    // ********************************************
    function parseDate(str) {
        if(!str) return new Date();
        if(str.toString().includes('/')) {
            const parts = str.split(' ')[0].split('/');
            return new Date(parts[2], parts[1]-1, parts[0]);
        }
        return new Date(str);
    }

    function initDynamicDropdown() {
        const select = document.getElementById('monthFilter');
        const currentSelection = select.value;
        select.innerHTML = ''; 
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const uniqueMonths = new Set();
        const today = new Date();
        uniqueMonths.add(`${today.getFullYear()}-${today.getMonth()}`);

        allData.forEach(item => {
            if(!item.Date) return;
            const d = parseDate(item.Date);
            uniqueMonths.add(`${d.getFullYear()}-${d.getMonth()}`);
        });

        const sortedMonths = Array.from(uniqueMonths).sort((a,b) => {
            const [y1, m1] = a.split('-').map(Number);
            const [y2, m2] = b.split('-').map(Number);
            return (y2 - y1) || (m2 - m1);
        });

        sortedMonths.forEach(key => {
            const [year, monthIdx] = key.split('-').map(Number);
            const yy = year.toString().slice(-2);
            const label = `${monthNames[monthIdx]} ${yy}`;
            const option = document.createElement('option');
            option.value = key; option.text = label; select.appendChild(option);
        });

        if (currentSelection && Array.from(select.options).some(o => o.value === currentSelection)) {
            select.value = currentSelection;
        } else if(select.options.length > 0) {
            select.selectedIndex = 0;
            handleMonthChange();
        }
    }

    function handleMonthChange() {
        const val = document.getElementById('monthFilter').value;
        if(!val) return;
        const [y, m] = val.split('-');
        currentFilter = { year: parseInt(y), month: parseInt(m) };
        applyFilter();
    }

    function applyFilter() {
        const filtered = allData.filter(item => {
            const d = parseDate(item.Date);
            return d.getFullYear() === currentFilter.year && d.getMonth() === currentFilter.month;
        });
        filtered.sort((a, b) => parseDate(b.Date) - parseDate(a.Date));
        renderList(filtered);
        calculateStats(filtered);
        if(document.getElementById('tab-stats').style.display === 'block') renderStats();
    }

    function renderList(data) {
    const container = document.getElementById('transaction-container');
    container.innerHTML = '';
    
    if(data.length === 0) { 
        document.getElementById('no-data').classList.remove('hidden'); 
        return; 
    }
    document.getElementById('no-data').classList.add('hidden');

    const grouped = {};
    data.forEach(item => {
        const dObj = parseDate(item.Date);
        const key = `${dObj.getFullYear()}-${dObj.getMonth()}-${dObj.getDate()}`;
        if(!grouped[key]) grouped[key] = { date: dObj, items: [], in: 0, out: 0 };
        grouped[key].items.push(item);
        
        let val = parseFloat(String(item.Amount).replace(/,/g, '')) || 0;
        if(item.Type === 'Income') grouped[key].in += val;
        else grouped[key].out += val;
    });

    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    Object.values(grouped).forEach(group => {
        const d = group.date;
        const dayName = dayNames[d.getDay()];
        const dateNum = String(d.getDate()).padStart(2,'0');
        const fullDate = `${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear().toString().slice(-2)}`;
        const badgeColor = (dayName === "Sun") ? "bg-red-500" : "bg-blue-500";
        
        const groupDiv = document.createElement('div');
        // ‚úÖ FIXED: Removed 'overflow-hidden' to allow sticky header to float
        groupDiv.className = 'bg-white mb-2 shadow-sm rounded-xl';

        let headerHtml = `
            <div class="day-header">
                <div class="date-block">
                    <span class="date-day">${dateNum}</span>
                    <span class="day-badge ${badgeColor}">${dayName}</span>
                    <span class="date-full">${fullDate}</span>
                </div>
                <div class="flex items-center gap-4">
                    ${group.in > 0 ? `<div class="text-right"><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">IN</p><p class="text-xs font-black text-emerald-600">‚Çπ${group.in.toLocaleString()}</p></div>` : ''}
                    ${group.out > 0 ? `<div class="text-right"><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">OUT</p><p class="text-xs font-black text-rose-500">‚Çπ${group.out.toLocaleString()}</p></div>` : ''}
                </div>
            </div>`;
        
        let itemsHtml = '';
        group.items.forEach(item => { itemsHtml += createEntryHTML(item); });
        
        groupDiv.innerHTML = headerHtml + '<div>' + itemsHtml + '</div>';
        container.appendChild(groupDiv);
    });
    
    // Attach Click Listeners
    document.querySelectorAll('.entry-row').forEach(row => {
        row.onclick = function() {
            try {
                const item = JSON.parse(decodeURIComponent(this.dataset.item));
                openModal('edit', item);
            } catch(e) { console.error("Error opening item", e); }
        }
    });
}

    function createEntryHTML(item) {
        let emoji = 'üõí';
        if (item['Sub-Category']) { const match = item['Sub-Category'].match(/[\p{Emoji}\u200d]+/u); if (match) emoji = match[0]; }
        if (emoji === 'üõí') {
            if (item.Type === 'Income') emoji = 'üí∞';
            else if (item.Category.includes('INVEST')) emoji = 'üìà';
            else if (item.Category.includes('WANTS')) emoji = 'üéâ';
        }
        let mainTitle = item.Note && item.Note.trim() ? item.Note : item.Description;
        let subDesc = (item.Note && item.Note.trim() && item.Description && item.Description !== item.Note) ? item.Description : '';
        let mainCat = item.Category.replace(/[\p{Emoji}\u200d]+/u, '').trim(); 
        let subCat = item['Sub-Category'] ? item['Sub-Category'].replace(/[\p{Emoji}\u200d]+/u, '').trim() : '';
        let amtColor = item.Type === 'Income' ? 'text-emerald-600' : 'text-slate-800';
        const safeItem = encodeURIComponent(JSON.stringify(item));

        return `
            <div class="entry-row" data-item="${safeItem}">
                <div class="col-icon">${emoji}</div>
                <div class="col-text">
                    <div class="text-[0.95rem] font-bold text-slate-700 truncate leading-snug">${mainTitle}</div>
                    ${subDesc ? `<div class="text-[11px] text-slate-400 truncate leading-tight mt-0.5">${subDesc}</div>` : ''}
                    <div class="text-[10px] font-semibold text-slate-400 mt-0.5 truncate uppercase tracking-wide">
                        <span class="text-indigo-500">${mainCat}</span>
                        ${subCat ? `<span class="mx-1 text-slate-300">‚Ä¢</span> ${subCat}` : ''}
                    </div>
                </div>
                <div class="col-amt">
                    <div class="text-[0.95rem] font-black ${amtColor} font-mono leading-snug">‚Çπ${parseFloat(item.Amount).toLocaleString()}</div>
                    <div class="text-[9px] font-bold text-slate-400 mt-0.5 uppercase tracking-wide bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 inline-block">${item.Account}</div>
                </div>
            </div>`;
    }

    function calculateStats(data) {
        let inc=0, exp=0, inv=0;
        data.forEach(i => {
            let v = parseFloat(String(i.Amount).replace(/,/g, '')) || 0;
            if(i.Type === 'Income') inc += v;
            else if(i.Type === 'Investment' || i.Category.includes('INVEST')) inv += v;
            else exp += v;
        });
        const fmt = n => `‚Çπ${n.toLocaleString('en-IN')}`;
        document.getElementById('net-balance').innerText = fmt(inc - exp - inv);
        document.getElementById('total-income').innerText = fmt(inc);
        document.getElementById('total-expense').innerText = fmt(exp);
        document.getElementById('total-invest').innerText = fmt(inv);
    }

    function toggleChartLegend() { showChartLegend = !showChartLegend; renderStats(); }
    function renderStats() {
        const typeFilter = document.getElementById('statsType').value;
        const groupFilter = document.getElementById('statsGroup').value;
        const filtered = allData.filter(item => {
            const d = parseDate(item.Date);
            return d.getFullYear() === currentFilter.year && d.getMonth() === currentFilter.month && item.Type === typeFilter;
        });
        const totals = {}; let total = 0;
        filtered.forEach(i => {
            let v = parseFloat(String(i.Amount).replace(/,/g, '')) || 0;
            let key = (groupFilter === 'sub_category') ? (i['Sub-Category'] || i.Category) : i.Category;
            key = key.replace(/[\p{Emoji}\u200d]+/u, '').trim();
            if(!totals[key]) totals[key] = 0; totals[key] += v; total += v;
        });
        document.getElementById('chartTotal').innerText = `‚Çπ${total.toLocaleString()}`;
        const labels = Object.keys(totals); const data = Object.values(totals);
        const colors = ['#4f46e5', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
        
        if(expenseChart) expenseChart.destroy();
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: showChartLegend, position: 'bottom', labels: { usePointStyle: true, padding: 15, font: { size: 10 } } } }, cutout: '70%' }
        });
        
        const listDiv = document.getElementById('stats-list'); listDiv.innerHTML = '';
        Object.entries(totals).sort((a,b) => b[1]-a[1]).forEach(([k,v], i) => {
            const pct = total > 0 ? ((v/total)*100).toFixed(1) : 0;
            const col = colors[i % colors.length];
            listDiv.innerHTML += `<div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-xl"><div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full" style="background:${col}"></div><div><p class="text-xs font-bold text-slate-700">${k}</p><div class="w-20 h-1 bg-slate-100 rounded-full mt-1"><div style="width:${pct}%; background:${col}" class="h-full rounded-full"></div></div></div></div><div class="text-right"><p class="text-xs font-bold text-slate-800">‚Çπ${v.toLocaleString()}</p><p class="text-[9px] text-slate-400 font-bold">${pct}%</p></div></div>`;
        });
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => { b.classList.remove('text-indigo-600'); b.classList.add('text-slate-400'); });
        btn.classList.add('text-indigo-600');
        if(id === 'stats') renderStats();
    }
	
	// Set Dynamic Greeting based on Time ‚è∞
        const hour = new Date().getHours();
        const greetElement = document.getElementById('greeting-text');
        let greeting = "Welcome Back";
        
        if (hour < 12) greeting = "Good Morning ‚òÄÔ∏è";
        else if (hour < 18) greeting = "Good Afternoon üå§Ô∏è";
        else greeting = "Good Evening üåô";
        
        if(greetElement) greetElement.innerText = greeting;
	
</script>
</body>
</html>
